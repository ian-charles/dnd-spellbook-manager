#!/bin/bash

# Step 1: Run Claude Code review
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "Step 1: Code Review"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# Get directory where this hook is located
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Call pre-commit-review from same directory
"$HOOK_DIR/pre-commit-review"
if [ $? -ne 0 ]; then
  echo "โ Code review failed! Commit aborted."
  exit 1
fi

# Step 2: Ensure dev server is running for E2E tests
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "Step 2: Checking Dev Server"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# Function to check if port is in use (cross-platform)
check_port() {
  if command -v lsof &> /dev/null; then
    # Unix/Mac: use lsof
    lsof -Pi :5173 -sTCP:LISTEN -t >/dev/null 2>&1
  else
    # Windows Git Bash: use netstat
    netstat -ano 2>/dev/null | grep -q ":5173.*LISTENING"
  fi
  return $?
}

# Check if dev server is already running on port 5173
SERVER_RUNNING=false
if check_port; then
  echo "โ Dev server already running on port 5173"
  SERVER_RUNNING=true
else
  echo "๐ Starting dev server for E2E tests..."
  npm run dev > /tmp/vite-dev-server.log 2>&1 &
  DEV_SERVER_PID=$!

  # Wait for server to be ready (max 30 seconds)
  echo "โณ Waiting for dev server to be ready..."
  for i in {1..30}; do
    if check_port; then
      echo "โ Dev server started on port 5173"
      SERVER_RUNNING=true
      break
    fi
    sleep 1
  done

  if [ "$SERVER_RUNNING" = false ]; then
    echo "โ Dev server failed to start! Commit aborted."
    echo "Check /tmp/vite-dev-server.log for details"
    kill $DEV_SERVER_PID 2>/dev/null
    exit 1
  fi
fi

# Step 3: Run tests
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "Step 3: Running Tests"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
# Run unit tests only (exclude e2e tests which require Puppeteer)
npx vitest --run
TEST_EXIT_CODE=$?

# Step 4: Clean up dev server if we started it
if [ -n "$DEV_SERVER_PID" ]; then
  echo ""
  echo "๐งน Stopping dev server..."
  kill $DEV_SERVER_PID 2>/dev/null
  # Also kill any child processes
  pkill -P $DEV_SERVER_PID 2>/dev/null
fi

# Check test results
if [ $TEST_EXIT_CODE -ne 0 ]; then
  echo "โ Tests failed! Commit aborted."
  echo "Fix the failing tests before committing."
  exit 1
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ All checks passed - proceeding with commit"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
